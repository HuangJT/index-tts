# IndexTTS HTTP API ä½¿ç”¨è¯´æ˜

## é¡¹ç›®æ”¹é€ å®Œæˆ âœ…

å·²æˆåŠŸä¸ºIndexTTSé¡¹ç›®æ·»åŠ äº†HTTP APIæ¥å£ï¼Œæ”¯æŒå‚è€ƒéŸ³é¢‘åˆæˆå’ŒéŸ³é¢‘å‚æ•°æ§åˆ¶ï¼ˆéŸ³è°ƒã€éŸ³é€Ÿã€éŸ³é‡ï¼‰ï¼ŒåŒæ—¶ä¿æŒåŸæœ‰Gradioç•Œé¢ä¸å˜ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

- âœ… **å‚è€ƒéŸ³é¢‘ç®¡ç†**: æ”¯æŒä¸Šä¼ ã€åˆ—å‡ºã€åˆ é™¤å‚è€ƒéŸ³é¢‘æ–‡ä»¶
- âœ… **è¯­éŸ³åˆæˆ**: åŸºäºå‚è€ƒéŸ³é¢‘è¿›è¡Œé›¶æ ·æœ¬è¯­éŸ³å…‹éš†
- âœ… **éŸ³é¢‘å‚æ•°æ§åˆ¶**: æ”¯æŒéŸ³è°ƒã€è¯­é€Ÿã€éŸ³é‡è°ƒæ•´
- âœ… **å¤šç§éŸ³é¢‘æ ¼å¼**: æ”¯æŒMP3å’ŒWAVæ ¼å¼è¾“å‡ºï¼Œé»˜è®¤MP3
- âœ… **åŒæ¨ç†æ¨¡å¼**: æ”¯æŒæ™®é€šæ¨ç†å’Œå¿«é€Ÿæ¨ç†æ¨¡å¼
- âœ… **å®Œæ•´API**: RESTful APIæ¥å£ï¼Œæ”¯æŒå„ç§ç¼–ç¨‹è¯­è¨€è°ƒç”¨
- âœ… **Webç•Œé¢ä¿æŒ**: åŸæœ‰Gradioç•Œé¢åŠŸèƒ½ä¸å—å½±å“

## ğŸ“ ç›®å½•ç»“æ„

```
index-tts/
â”œâ”€â”€ reference_audios/              # å‚è€ƒéŸ³é¢‘å­˜å‚¨ç›®å½• (æ–°å¢)
â”‚   â”œâ”€â”€ å’Œå°ç¾æ¸…æ¥šä¸»æ’­.mp3         # ä½ çš„å‚è€ƒéŸ³é¢‘æ–‡ä»¶
â”‚   â”œâ”€â”€ é™ˆå¿ƒå¿ƒå¤§æ°”ä¸»æ’­.mp3         # ä½ çš„å‚è€ƒéŸ³é¢‘æ–‡ä»¶
â”‚   â””â”€â”€ TVBå¥³å£°.mp3               # ä½ çš„å‚è€ƒéŸ³é¢‘æ–‡ä»¶
â”œâ”€â”€ outputs/api/                   # APIç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶ (æ–°å¢)
â”œâ”€â”€ api_server.py                  # HTTP APIæœåŠ¡å™¨ (æ–°å¢)
â”œâ”€â”€ start_services.py              # æœåŠ¡å¯åŠ¨è„šæœ¬ (æ–°å¢)
â”œâ”€â”€ api_example.py                 # APIä½¿ç”¨ç¤ºä¾‹ (æ–°å¢)
â”œâ”€â”€ manage_reference_audios.py     # éŸ³é¢‘ç®¡ç†å·¥å…· (æ–°å¢)
â”œâ”€â”€ API.md                         # APIè¯¦ç»†æ–‡æ¡£ (æ–°å¢)
â”œâ”€â”€ webui.py                       # åŸæœ‰Gradioç•Œé¢ (ä¿æŒä¸å˜)
â””â”€â”€ ...                           # å…¶ä»–åŸæœ‰æ–‡ä»¶
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# å®‰è£…æ–°å¢çš„APIä¾èµ–
pip install fastapi uvicorn python-multipart pydub
```

### 2. å‡†å¤‡å‚è€ƒéŸ³é¢‘

å°†ä½ çš„å‚è€ƒéŸ³é¢‘æ–‡ä»¶æ”¾åˆ° `reference_audios/` ç›®å½•ä¸‹ï¼š

```bash
# æ‰‹åŠ¨å¤åˆ¶æ–‡ä»¶
cp "å’Œå°ç¾æ¸…æ¥šä¸»æ’­.mp3" reference_audios/
cp "é™ˆå¿ƒå¿ƒå¤§æ°”ä¸»æ’­.mp3" reference_audios/
cp "TVBå¥³å£°.mp3" reference_audios/

# æˆ–ä½¿ç”¨ç®¡ç†å·¥å…·
python manage_reference_audios.py add "path/to/å’Œå°ç¾æ¸…æ¥šä¸»æ’­.mp3"
python manage_reference_audios.py list
```

### 3. å¯åŠ¨æœåŠ¡

#### æ–¹å¼1: ä»…å¯åŠ¨APIæœåŠ¡
```bash
python api_server.py --host 0.0.0.0 --port 8000
```

#### æ–¹å¼2: åŒæ—¶å¯åŠ¨APIå’ŒWebç•Œé¢ (æ¨è)
```bash
python start_services.py --mode both
```

#### æ–¹å¼3: ä»…å¯åŠ¨Webç•Œé¢ (åŸæœ‰åŠŸèƒ½)
```bash
python webui.py
```

### 4. æµ‹è¯•API

```bash
# è¿è¡Œæµ‹è¯•ç¤ºä¾‹
python api_example.py
```

## ğŸ”§ API ä½¿ç”¨æ–¹æ³•

### åŸºç¡€è°ƒç”¨

```python
import requests

# 1. åˆ—å‡ºå¯ç”¨çš„å‚è€ƒéŸ³é¢‘
response = requests.get("http://localhost:8000/reference_audios")
print(response.json())

# 2. åˆæˆè¯­éŸ³
data = {
    "text": "å¤§å®¶å¥½ï¼Œæˆ‘ç°åœ¨æ­£åœ¨æµ‹è¯•IndexTTSçš„APIæ¥å£åŠŸèƒ½ã€‚",
    "reference_audio": "å’Œå°ç¾æ¸…æ¥šä¸»æ’­.mp3"
}
response = requests.post("http://localhost:8000/synthesize", json=data)
result = response.json()

# 3. ä¸‹è½½ç”Ÿæˆçš„éŸ³é¢‘
if result["success"]:
    audio_url = f"http://localhost:8000{result['audio_url']}"
    audio_response = requests.get(audio_url)
    with open("output.wav", "wb") as f:
        f.write(audio_response.content)
```

### éŸ³é¢‘å‚æ•°æ§åˆ¶

```python
# è°ƒæ•´éŸ³è°ƒã€è¯­é€Ÿã€éŸ³é‡ï¼Œè¾“å‡ºMP3æ ¼å¼
data = {
    "text": "è¿™æ˜¯ä¸€ä¸ªéŸ³é¢‘å‚æ•°è°ƒæ•´çš„æµ‹è¯•ã€‚",
    "reference_audio": "é™ˆå¿ƒå¿ƒå¤§æ°”ä¸»æ’­.mp3",
    "output_format": "mp3", # è¾“å‡ºMP3æ ¼å¼ï¼ˆé»˜è®¤ï¼‰
    "pitch_shift": 2.0,    # æé«˜2ä¸ªåŠéŸ³
    "speed_rate": 1.2,     # è¯­é€ŸåŠ å¿«20%
    "volume_gain": 3.0,    # éŸ³é‡å¢åŠ 3dB
    "infer_mode": "fast"   # ä½¿ç”¨å¿«é€Ÿæ¨ç†
}
response = requests.post("http://localhost:8000/synthesize", json=data)

# è¾“å‡ºWAVæ ¼å¼ï¼ˆæ— æŸéŸ³è´¨ï¼‰
data_wav = {
    "text": "è¿™æ˜¯WAVæ ¼å¼çš„é«˜è´¨é‡éŸ³é¢‘æµ‹è¯•ã€‚",
    "reference_audio": "TVBå¥³å£°.mp3",
    "output_format": "wav", # è¾“å‡ºWAVæ ¼å¼
    "pitch_shift": -1.0,   # é™ä½1ä¸ªåŠéŸ³
    "speed_rate": 0.9,     # è¯­é€Ÿæ”¾æ…¢10%
    "volume_gain": 2.0     # éŸ³é‡å¢åŠ 2dB
}
response = requests.post("http://localhost:8000/synthesize", json=data_wav)
```

### cURL è°ƒç”¨ç¤ºä¾‹

```bash
# åˆæˆè¯­éŸ³
curl -X POST "http://localhost:8000/synthesize" \
  -H "Content-Type: application/json" \
  -d '{
    "text": "ä½ å¥½ï¼Œè¿™æ˜¯é€šè¿‡cURLè°ƒç”¨çš„æµ‹è¯•ã€‚",
    "reference_audio": "TVBå¥³å£°.mp3",
    "pitch_shift": -1.0,
    "speed_rate": 0.9,
    "volume_gain": 2.0
  }'

# ä¸‹è½½éŸ³é¢‘
curl -O "http://localhost:8000/audio/tts_1640995400000.wav"
```

## ğŸ“Š å‚æ•°è¯´æ˜

### éŸ³é¢‘æ§åˆ¶å‚æ•°

| å‚æ•° | èŒƒå›´ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `output_format` | "mp3", "wav" | "mp3" | è¾“å‡ºéŸ³é¢‘æ ¼å¼ |
| `pitch_shift` | -12.0 ~ 12.0 | 0.0 | éŸ³è°ƒè°ƒæ•´(åŠéŸ³) |
| `speed_rate` | 0.5 ~ 2.0 | 1.0 | è¯­é€Ÿå€ç‡ |
| `volume_gain` | -20.0 ~ 20.0 | 0.0 | éŸ³é‡å¢ç›Š(dB) |

### æ¨ç†å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `infer_mode` | string | "fast" | æ¨ç†æ¨¡å¼("normal"/"fast") |
| `do_sample` | boolean | true | æ˜¯å¦ä½¿ç”¨é‡‡æ · |
| `top_p` | float | 0.8 | Top-pé‡‡æ ·å‚æ•° |
| `top_k` | integer | 30 | Top-ké‡‡æ ·å‚æ•° |
| `temperature` | float | 1.0 | æ¸©åº¦å‚æ•° |
| `repetition_penalty` | float | 10.0 | é‡å¤æƒ©ç½š |
| `max_mel_tokens` | integer | 600 | æœ€å¤§mel tokenæ•° |

## ğŸ› ï¸ ç®¡ç†å·¥å…·

### å‚è€ƒéŸ³é¢‘ç®¡ç†

```bash
# åˆ—å‡ºæ‰€æœ‰éŸ³é¢‘
python manage_reference_audios.py list

# æ·»åŠ éŸ³é¢‘æ–‡ä»¶
python manage_reference_audios.py add "path/to/audio.wav" --name "æ–°åç§°.wav"

# åˆ é™¤éŸ³é¢‘æ–‡ä»¶
python manage_reference_audios.py remove "æ–‡ä»¶å.mp3"

# é‡å‘½åéŸ³é¢‘æ–‡ä»¶
python manage_reference_audios.py rename "æ—§åç§°.mp3" "æ–°åç§°.mp3"
```

## ğŸŒ æœåŠ¡è®¿é—®

å¯åŠ¨æœåŠ¡åï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š

- **APIæœåŠ¡**: http://localhost:8000
- **APIæ–‡æ¡£**: http://localhost:8000/docs (è‡ªåŠ¨ç”Ÿæˆçš„Swaggeræ–‡æ¡£)
- **Webç•Œé¢**: http://localhost:7860 (å¦‚æœåŒæ—¶å¯åŠ¨)

## ğŸ“ å®Œæ•´ç¤ºä¾‹

### Pythonå®Œæ•´ç¤ºä¾‹

```python
#!/usr/bin/env python3
import requests
import time

API_BASE = "http://localhost:8000"

def main():
    # 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
    health = requests.get(f"{API_BASE}/health")
    print("æœåŠ¡çŠ¶æ€:", health.json())
    
    # 2. åˆ—å‡ºå‚è€ƒéŸ³é¢‘
    audios = requests.get(f"{API_BASE}/reference_audios")
    print("å¯ç”¨éŸ³é¢‘:", [a["filename"] for a in audios.json()["reference_audios"]])
    
    # 3. åˆæˆè¯­éŸ³ - åŸºç¡€ç‰ˆæœ¬
    basic_request = {
        "text": "å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯é€šè¿‡APIè°ƒç”¨ç”Ÿæˆçš„è¯­éŸ³ã€‚",
        "reference_audio": "å’Œå°ç¾æ¸…æ¥šä¸»æ’­.mp3"
    }
    
    response = requests.post(f"{API_BASE}/synthesize", json=basic_request)
    result = response.json()
    
    if result["success"]:
        print(f"åˆæˆæˆåŠŸ! éŸ³é¢‘URL: {result['audio_url']}")
        
        # ä¸‹è½½éŸ³é¢‘
        audio_response = requests.get(f"{API_BASE}{result['audio_url']}")
        with open(f"output_basic_{int(time.time())}.wav", "wb") as f:
            f.write(audio_response.content)
    
    # 4. åˆæˆè¯­éŸ³ - å‚æ•°è°ƒæ•´ç‰ˆæœ¬
    advanced_request = {
        "text": "è¿™æ˜¯ä¸€ä¸ªéŸ³è°ƒæé«˜ã€è¯­é€ŸåŠ å¿«çš„æµ‹è¯•è¯­éŸ³ã€‚",
        "reference_audio": "é™ˆå¿ƒå¿ƒå¤§æ°”ä¸»æ’­.mp3",
        "pitch_shift": 3.0,     # æé«˜3ä¸ªåŠéŸ³
        "speed_rate": 1.3,      # è¯­é€ŸåŠ å¿«30%
        "volume_gain": 5.0,     # éŸ³é‡å¢åŠ 5dB
        "infer_mode": "fast",
        "temperature": 0.9      # é™ä½éšæœºæ€§
    }
    
    response = requests.post(f"{API_BASE}/synthesize", json=advanced_request)
    result = response.json()
    
    if result["success"]:
        print(f"é«˜çº§åˆæˆæˆåŠŸ! å¤„ç†æ—¶é—´: {result['processing_time']:.2f}ç§’")
        
        # ä¸‹è½½éŸ³é¢‘
        audio_response = requests.get(f"{API_BASE}{result['audio_url']}")
        with open(f"output_advanced_{int(time.time())}.wav", "wb") as f:
            f.write(audio_response.content)

if __name__ == "__main__":
    main()
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ¨¡å‹åŠ è½½å¤±è´¥**
   - ç¡®ä¿ `checkpoints/` ç›®å½•ä¸‹æœ‰æ‰€æœ‰å¿…éœ€çš„æ¨¡å‹æ–‡ä»¶
   - æ£€æŸ¥ `checkpoints/config.yaml` æ˜¯å¦å­˜åœ¨

2. **å‚è€ƒéŸ³é¢‘ä¸å­˜åœ¨**
   - ç¡®ä¿éŸ³é¢‘æ–‡ä»¶åœ¨ `reference_audios/` ç›®å½•ä¸‹
   - ä½¿ç”¨ `python manage_reference_audios.py list` æ£€æŸ¥

3. **éŸ³é¢‘æ•ˆæœä¸ç†æƒ³**
   - è°ƒæ•´ `pitch_shift`, `speed_rate`, `volume_gain` å‚æ•°
   - å°è¯•ä¸åŒçš„æ¨ç†å‚æ•°ç»„åˆ

4. **æœåŠ¡å¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
   - ç¡®ä¿å®‰è£…äº†æ‰€æœ‰ä¾èµ–: `pip install -r requirements.txt`

### æ—¥å¿—æŸ¥çœ‹

APIæœåŠ¡å™¨ä¼šè¾“å‡ºè¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- æ¨¡å‹åŠ è½½çŠ¶æ€
- è¯·æ±‚å¤„ç†è¿‡ç¨‹
- é”™è¯¯ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ª

## ğŸ‰ æ€»ç»“

ç°åœ¨ä½ å·²ç»æˆåŠŸæ”¹é€ äº†IndexTTSé¡¹ç›®ï¼Œå…·å¤‡ä»¥ä¸‹èƒ½åŠ›ï¼š

1. âœ… **å‚è€ƒéŸ³é¢‘å­˜å‚¨**: `reference_audios/` ç›®å½•ç®¡ç†ä½ çš„éŸ³é¢‘æ–‡ä»¶
2. âœ… **HTTP APIè°ƒç”¨**: é€šè¿‡RESTful APIè¿›è¡Œè¯­éŸ³åˆæˆ
3. âœ… **éŸ³é¢‘å‚æ•°æ§åˆ¶**: æ”¯æŒéŸ³è°ƒã€è¯­é€Ÿã€éŸ³é‡è°ƒæ•´
4. âœ… **åŒæ¨¡å¼è¿è¡Œ**: å¯ä»¥å•ç‹¬è¿è¡ŒAPIæˆ–åŒæ—¶è¿è¡ŒAPI+Webç•Œé¢
5. âœ… **å®Œæ•´å·¥å…·é“¾**: åŒ…å«ç®¡ç†å·¥å…·ã€ç¤ºä¾‹ä»£ç ã€è¯¦ç»†æ–‡æ¡£

ä½ å¯ä»¥å°†å‚è€ƒéŸ³é¢‘æ–‡ä»¶æ”¾åˆ° `reference_audios/` ç›®å½•ä¸‹ï¼Œç„¶åé€šè¿‡HTTP APIè°ƒç”¨æ¥å®ç°è¯­éŸ³åˆæˆï¼Œæ»¡è¶³å…¶ä»–åº”ç”¨çš„é›†æˆéœ€æ±‚ã€‚

**ä¸‹ä¸€æ­¥æ“ä½œ**:
1. å°†ä½ çš„éŸ³é¢‘æ–‡ä»¶å¤åˆ¶åˆ° `reference_audios/` ç›®å½•
2. è¿è¡Œ `python start_services.py --mode both` å¯åŠ¨æœåŠ¡
3. ä½¿ç”¨ `python api_example.py` æµ‹è¯•APIåŠŸèƒ½
4. æ ¹æ®éœ€è¦è°ƒæ•´éŸ³é¢‘å‚æ•°è¿›è¡Œåˆæˆ